(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/pay/pay"],{76:function(e,t,n){"use strict";(function(e,t){var r=n(4);n(26),n(27);r(n(25));var o=r(n(77));e.__webpack_require_UNI_MP_PLUGIN__=n,t(o.default)}).call(this,n(1)["default"],n(2)["createPage"])},77:function(e,t,n){"use strict";n.r(t);var r=n(78),o=n(80);for(var a in o)["default"].indexOf(a)<0&&function(e){n.d(t,e,(function(){return o[e]}))}(a);n(82);var i,c=n(44),s=Object(c["default"])(o["default"],r["render"],r["staticRenderFns"],!1,null,"c10d0c50",null,!1,r["components"],i);s.options.__file="pages/pay/pay.vue",t["default"]=s.exports},78:function(e,t,n){"use strict";n.r(t);var r=n(79);n.d(t,"render",(function(){return r["render"]})),n.d(t,"staticRenderFns",(function(){return r["staticRenderFns"]})),n.d(t,"recyclableRender",(function(){return r["recyclableRender"]})),n.d(t,"components",(function(){return r["components"]}))},79:function(e,t,n){"use strict";var r;n.r(t),n.d(t,"render",(function(){return o})),n.d(t,"staticRenderFns",(function(){return i})),n.d(t,"recyclableRender",(function(){return a})),n.d(t,"components",(function(){return r}));try{r={listCell:function(){return n.e("components/list-cell/list-cell").then(n.bind(null,169))},modal:function(){return n.e("components/modal/modal").then(n.bind(null,155))}}}catch(c){if(-1===c.message.indexOf("Cannot find module")||-1===c.message.indexOf(".vue"))throw c;console.error(c.message),console.error("1. 排查组件名称拼写是否正确"),console.error("2. 排查组件是否符合 easycom 规范，文档：https://uniapp.dcloud.net.cn/collocation/pages?id=easycom"),console.error("3. 若组件不符合 easycom 规范，需手动引入，并在 components 中注册该组件")}var o=function(){var e=this,t=e.$createElement;e._self._c;e._isMounted||(e.e0=function(t){e.ensureAddressModalVisible=!1})},a=!1,i=[];o._withStripped=!0},80:function(e,t,n){"use strict";n.r(t);var r=n(81),o=n.n(r);for(var a in r)["default"].indexOf(a)<0&&function(e){n.d(t,e,(function(){return r[e]}))}(a);t["default"]=o.a},81:function(e,t,n){"use strict";(function(e,r){var o=n(4);Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var a=o(n(28)),i=o(n(31)),c=o(n(11)),s=n(49),u=n(46);function d(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?d(Object(n),!0).forEach((function(t){(0,c.default)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):d(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var m=function(){n.e("components/list-cell/list-cell").then(function(){return resolve(n(169))}.bind(null,n)).catch(n.oe)},f=function(){n.e("components/modal/modal").then(function(){return resolve(n(155))}.bind(null,n)).catch(n.oe)};function p(){var e=new Date,t=288e5,n=new Date(e.getTime()+t);return n.toISOString().slice(0,19).replace("T"," ")}var b={components:{listCell:m,modal:f},data:function(){return{diningOption:"堂食",cart:[],form:{remark:""},ensureAddressModalVisible:!1,mobilePhone:""}},computed:l(l({},(0,s.mapState)(["orderType","address","store","client"])),{},{total:function(){return this.cart.reduce((function(e,t){return e+t.number*t.price}),0)},amount:function(){return this.cart.reduce((function(e,t){return e+t.number*t.price}),0)}}),onLoad:function(t){this.mobilePhone=u.Member.mobilePhone;var n=t.remark;this.cart=e.getStorageSync("cart"),n&&this.$set(this.form,"remark",n)},methods:l(l({},(0,s.mapMutations)(["SET_ORDER"])),{},{goToRemark:function(){e.navigateTo({url:"/pages/remark/remark?remark="+this.form.remark})},chooseAddress:function(){e.navigateTo({url:"/pages/address/address?is_choose=true&scene=pay"})},goToPackages:function(){e.navigateTo({url:"/pages/packages/index"})},submit:function(){"takeout"===this.orderType?this.ensureAddressModalVisible=!0:(this.addOrderToMember(),this.updateUserInfoInDatabase(),this.pay())},addOrderToMember:function(){var e=p(),t=(Math.floor(Date.now()/1e3)+4e10).toString(),n=this.cart.reduce((function(e,t){return e+parseFloat(t.price)*t.number}),0).toFixed(2),o={pay_mode:"微信支付",goods_num:this.cart.reduce((function(e,t){return e+t.number}),0),status_text:"已完成",remark:this.form.remark,mobile:u.Member.mobilePhone,user_name:u.Member.nickname,store:{name:"恩溪烧烤店"},completed_time:e,amount:n,productioned_time:e,postscript:this.diningOption,sort_num:u.Member.mobilePhone.slice(-4),order_no:t,review:{},goods:this.cart.map((function(e){return{number:e.number,price:e.price,image:e.image,amount:(e.price*e.number).toFixed(2),name:e.name}}))};u.Member.orders.unshift(o),u.Member.pointNum+=parseFloat(n),this.sendBillToMQTT(o);var c=r.database();this.cart.forEach(function(){var e=(0,i.default)(a.default.mark((function e(t){var n,r,o,i;return a.default.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,c.collection("shop_list").where({"goods_list.id":t.id}).get();case 3:if(n=e.sent,!(n.result.data.length>0)){e.next=12;break}if(r=n.result.data[0],o=r.goods_list.findIndex((function(e){return e.id===t.id})),-1===o){e.next=12;break}return i=r.goods_list,i[o].sales+=t.number,e.next=12,c.collection("shop_list").doc(r._id).update({goods_list:i});case 12:e.next=17;break;case 14:e.prev=14,e.t0=e["catch"](0),console.error("Error updating sales for item ".concat(t.id,":"),e.t0);case 17:case"end":return e.stop()}}),e,null,[[0,14]])})));return function(t){return e.apply(this,arguments)}}())},updateUserInfoInDatabase:function(){return(0,i.default)(a.default.mark((function e(){return a.default.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,r.callFunction({name:"updateUserInfo",data:{mobilePhone:u.Member.mobilePhone,updateData:{orders:u.Member.orders,pointNum:u.Member.pointNum}}});case 3:e.next=8;break;case 5:e.prev=5,e.t0=e["catch"](0),console.error("更新用户信息失败",e.t0);case 8:case"end":return e.stop()}}),e,null,[[0,5]])})))()},selectOption:function(e){this.diningOption=e},pay:function(){e.showLoading({title:"加载中"}),e.removeStorageSync("cart"),e.reLaunch({url:"/pages/orders/orders"}),e.hideLoading()},sendBillToMQTT:function(e){var t=e.sort_num||"",n=e.postscript||"",r=e.completed_time||"",o=e.remark||"",a=e.goods.map((function(e){return{name:e.name,price:e.price,number:e.number,amount:e.amount}})),i=e.amount||"",c=e.user_name.charAt(0)+"****"||!1,s=e.mobile.replace(/(\d{3})\d{4}(\d{4})/,"$1****$2")||"",u=e.order_no||"",d="Ez4Canteen-esp8266",l={sortNum:t,postscript:n,completedTime:r,remark:o,goodsDetails:a,amount:i,userName:c,mobile:s,orderNo:u,TargetDevice:d};this.client.publish("/k1n5mcDd3Fr/mini/user/update",JSON.stringify(l))}})};t.default=b}).call(this,n(2)["default"],n(27)["default"])},82:function(e,t,n){"use strict";n.r(t);var r=n(83),o=n.n(r);for(var a in r)["default"].indexOf(a)<0&&function(e){n.d(t,e,(function(){return r[e]}))}(a);t["default"]=o.a},83:function(e,t,n){}},[[76,"common/runtime","common/vendor"]]]);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pages/pay/pay.js.map