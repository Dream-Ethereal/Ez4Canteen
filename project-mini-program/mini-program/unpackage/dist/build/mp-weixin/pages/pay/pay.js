(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/pay/pay"],{"3c2f":function(e,t,r){},"6eab":function(e,t,r){"use strict";r.d(t,"b",(function(){return o})),r.d(t,"c",(function(){return a})),r.d(t,"a",(function(){return n}));var n={listCell:function(){return r.e("components/list-cell/list-cell").then(r.bind(null,"f04a"))},modal:function(){return r.e("components/modal/modal").then(r.bind(null,"044a"))}},o=function(){var e=this,t=e.$createElement;e._self._c;e._isMounted||(e.e0=function(t){e.ensureAddressModalVisible=!1})},a=[]},"984e":function(e,t,r){"use strict";(function(e,t){var n=r("47a9");r("e392"),r("861b");n(r("3240"));var o=n(r("a30a"));e.__webpack_require_UNI_MP_PLUGIN__=r,t(o.default)}).call(this,r("3223")["default"],r("df3c")["createPage"])},a30a:function(e,t,r){"use strict";r.r(t);var n=r("6eab"),o=r("cc52");for(var a in o)["default"].indexOf(a)<0&&function(e){r.d(t,e,(function(){return o[e]}))}(a);r("b07e");var i=r("828b"),c=Object(i["a"])(o["default"],n["b"],n["c"],!1,null,"8e25b7ec",null,!1,n["a"],void 0);t["default"]=c.exports},b07e:function(e,t,r){"use strict";var n=r("3c2f"),o=r.n(n);o.a},cc52:function(e,t,r){"use strict";r.r(t);var n=r("dd1e"),o=r.n(n);for(var a in n)["default"].indexOf(a)<0&&function(e){r.d(t,e,(function(){return n[e]}))}(a);t["default"]=o.a},dd1e:function(e,t,r){"use strict";(function(e,n){var o=r("47a9");Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var a=o(r("7eb4")),i=o(r("ee10")),c=o(r("7ca3")),u=r("8f59"),s=r("c2d6");function l(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function d(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?l(Object(r),!0).forEach((function(t){(0,c.default)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):l(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var m={components:{listCell:function(){r.e("components/list-cell/list-cell").then(function(){return resolve(r("f04a"))}.bind(null,r)).catch(r.oe)},modal:function(){r.e("components/modal/modal").then(function(){return resolve(r("044a"))}.bind(null,r)).catch(r.oe)}},data:function(){return{diningOption:"堂食",cart:[],form:{remark:""},ensureAddressModalVisible:!1,mobilePhone:""}},computed:d(d({},(0,u.mapState)(["orderType","address","store","client"])),{},{total:function(){return this.cart.reduce((function(e,t){return e+t.number*t.price}),0)},amount:function(){return this.cart.reduce((function(e,t){return e+t.number*t.price}),0)}}),onLoad:function(t){this.mobilePhone=s.Member.mobilePhone;var r=t.remark;this.cart=e.getStorageSync("cart"),r&&this.$set(this.form,"remark",r)},methods:d(d({},(0,u.mapMutations)(["SET_ORDER"])),{},{goToRemark:function(){e.navigateTo({url:"/pages/remark/remark?remark="+this.form.remark})},chooseAddress:function(){e.navigateTo({url:"/pages/address/address?is_choose=true&scene=pay"})},goToPackages:function(){e.navigateTo({url:"/pages/packages/index"})},submit:function(){"takeout"===this.orderType?this.ensureAddressModalVisible=!0:(this.addOrderToMember(),this.updateUserInfoInDatabase(),this.pay())},addOrderToMember:function(){var e=function(){var e=new Date,t=new Date(e.getTime()+288e5);return t.toISOString().slice(0,19).replace("T"," ")}(),t=(Math.floor(Date.now()/1e3)+4e10).toString(),r=this.cart.reduce((function(e,t){return e+parseFloat(t.price)*t.number}),0).toFixed(2),o={pay_mode:"微信支付",goods_num:this.cart.reduce((function(e,t){return e+t.number}),0),status_text:"已完成",remark:this.form.remark,mobile:s.Member.mobilePhone,user_name:s.Member.nickname,store:{name:"恩溪烧烤店"},completed_time:e,amount:r,productioned_time:e,postscript:this.diningOption,sort_num:s.Member.mobilePhone.slice(-4),order_no:t,review:{},goods:this.cart.map((function(e){return{number:e.number,price:e.price,image:e.image,amount:(e.price*e.number).toFixed(2),name:e.name}}))};s.Member.orders.unshift(o),s.Member.pointNum+=parseFloat(r),this.sendBillToMQTT(o);var c=n.database();this.cart.forEach(function(){var e=(0,i.default)(a.default.mark((function e(t){var r,n,o,i;return a.default.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,c.collection("shop_list").where({"goods_list.id":t.id}).get();case 3:if(r=e.sent,!(r.result.data.length>0)){e.next=12;break}if(n=r.result.data[0],o=n.goods_list.findIndex((function(e){return e.id===t.id})),-1===o){e.next=12;break}return i=n.goods_list,i[o].sales+=t.number,e.next=12,c.collection("shop_list").doc(n._id).update({goods_list:i});case 12:e.next=17;break;case 14:e.prev=14,e.t0=e["catch"](0),console.error("Error updating sales for item ".concat(t.id,":"),e.t0);case 17:case"end":return e.stop()}}),e,null,[[0,14]])})));return function(t){return e.apply(this,arguments)}}())},updateUserInfoInDatabase:function(){return(0,i.default)(a.default.mark((function e(){return a.default.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,n.callFunction({name:"updateUserInfo",data:{mobilePhone:s.Member.mobilePhone,updateData:{orders:s.Member.orders,pointNum:s.Member.pointNum}}});case 3:e.next=8;break;case 5:e.prev=5,e.t0=e["catch"](0),console.error("更新用户信息失败",e.t0);case 8:case"end":return e.stop()}}),e,null,[[0,5]])})))()},selectOption:function(e){this.diningOption=e},pay:function(){e.showLoading({title:"加载中"}),e.removeStorageSync("cart"),e.reLaunch({url:"/pages/orders/orders"}),e.hideLoading()},sendBillToMQTT:function(e){var t=e.sort_num||"",r=e.postscript||"",n=e.completed_time||"",o=e.remark||"",a=e.goods.map((function(e){return{name:e.name,price:e.price,number:e.number,amount:e.amount}})),i=e.amount||"",c=e.user_name.charAt(0)+"****"||!1,u=e.mobile.replace(/(\d{3})\d{4}(\d{4})/,"$1****$2")||"",s=e.order_no||"",l={sortNum:t,postscript:r,completedTime:n,remark:o,goodsDetails:a,amount:i,userName:c,mobile:u,orderNo:s,TargetDevice:"Ez4Canteen-esp8266"};this.client.publish("/k1n5mcDd3Fr/mini/user/update",JSON.stringify(l))}})};t.default=m}).call(this,r("df3c")["default"],r("861b")["default"])}},[["984e","common/runtime","common/vendor"]]]);